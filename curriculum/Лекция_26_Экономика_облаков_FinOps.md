# Лекция 26. Экономика облаков (FinOps)

Коротко: зачем и где применяется. FinOps — практика управления расходами и стоимостью при использовании облачных сервисов. Это сочетание финансов, инженерии и операционной практики, которое помогает командам принимать экономически обоснованные решения в облаке.

## Результаты обучения

После лекции вы:

- поймёте ключевые метрики и модели затрат в облаке (compute, storage, network, managed services);
- сможете настроить базовую стратегию учёта затрат: тэгирование, учёт по проектам/командам, chargeback/Showback;
- примените практики оптимизации: rightsizing, reserved/spot instances, autoscaling и lifecycle управления ресурсами;
- настроите бюджеты и алерты, используете инструменты (Cost Explorer, Billing Console, Kubecost);
- сформируете FinOps‑процесс: понимание, оптимизация, распределение ответственности и обратная связь.

## Пререквизиты

- Знание облачных технологий (IaaS/PaaS/FaaS) и сервисов (см. предыдущие лекции).
- Базовые навыки работы в Linux и с CLI провайдера (aws/az/gcloud).
- Понимание принципов мониторинга и SLO (SRE/наблюдаемость).

## Введение: картина мира

Облака дают гибкость и скорость, но без управления стоимостью можно быстро выйти за бюджет: автоматически масштабируемые VM, миллионы мелких хранилищ, тысячи запросов API. FinOps — это ответ: процесс и культура, где команды совместно управляют затратами, принимают решения на основе данных и внедряют технические практики экономии.

## Основные понятия и терминология

- FinOps: практика коллаборации между инженерами, финансовым отделом и менеджментом для оптимизации облачных затрат.
- TCO (Total Cost of Ownership): общая стоимость владения системой, включая прямые и косвенные издержки.
- Cost allocation/Tagging: разметка ресурсов для распределения затрат.
- Chargeback / Showback: модели распределения расходов внутри организации (оплата командой vs показ расходов).
- Reserved / Spot / On‑Demand: модели закупки ресурсов по различным ценовым схемам.
- Rightsizing: подбор подходящего размера ресурса под нагрузку.
- Cost per feature / cost per customer: бизнес‑метрики привязки затрат к продуктовым результатам.

## Пошаговое освоение темы

### Подтема 1. Где деньги утекают: основные статьи затрат

Определения:

- Compute (VM/containers/functions): оплата CPU/времени работающих инстансов.
- Storage: блочные, объектные, файловые — оплата за объём и операции.
- Network: исходящий трафик (egress), межзонный трафик.
- Managed services: БД, queues — часто фиксированная плата + операции.

Короткий вывод: крупные затраты часто приходят от compute и network, а «мелочёвка» — из большого количества маленьких хранилищ и неиспользуемых резервов.

Типичные ошибки: считать только стоимость VM и игнорировать сеть/операции; оставлять idle ресурсы и unattached volumes.

### Подтема 2. Видимость затрат: тэгирование и учёт

Определения:

- Tag/Label: метка ресурса (project, owner, env, cost_center).
- Cost Allocation Report: отчёт, распределяющий стоимость по тэгам/проектив.

```hcl
# Пример: Terraform tags (AWS)
resource "aws_instance" "app" {
  ami           = "ami-..."
  instance_type = "t3.micro"
  tags = {
    Name       = "my-app-01"
    Project    = "education"
    Owner      = "team-a"
    Environment= "staging"
  }
}
```

Пояснение к примеру: тэги позволяют разбивать счёт по проектам и владельцам; их нужно стандартизовать и автоматизировать в IaC.

Проверка: включите отчёты распределения затрат в консоли провайдера и убедитесь, что ресурс попал под нужный tag/label.

Типичные ошибки: отсутствие обязательных тэгов, разные варианты написания тега (Dev/DEV/dev), теги не применяются к сервисам управляемого уровня.

### Подтема 3. Правила оптимизации: rightsizing, autoscaling, spot и reserved

Определения:

- Rightsizing: корректировка размера (vCPU/RAM) под реальную нагрузку.
- Autoscaling: масштабирование по метрикам (CPU, requests, custom).
- Reserved instances / Savings Plans: скидки при долгосрочной оплате.
- Spot/Preemptible: дешёвые вычисления с возможностью прерывания.

```bash
# Пример запроса метрик для решения о rightsizing (AWS CLI)
aws cloudwatch get-metric-statistics --namespace AWS/EC2 --metric-name CPUUtilization \
  --start-time 2025-11-30T00:00:00Z --end-time 2025-12-01T00:00:00Z --period 3600 \
  --statistics Average --dimensions Name=InstanceId,Value=i-0123456789abcdef0
```

Пояснение к примеру: анализ средней загрузки CPU за период даёт основание для уменьшения/увеличения размера инстанса или внедрения autoscaling.

Проверка: получите историю метрик, сравните 95‑й и 50‑й перцентиль; если p95 << provisioned CPU — ресурс переразмерен.

Типичные ошибки: принимать решение только по среднему (avg) вместо p95/p99; не учитывать пиковые нагрузки и требования к latency.

### Подтема 4. Data и storage: lifecycle, tiering, и холодные хранилища

Определения:

- Lifecycle rules: автоматическое перемещение/удаление объектов (S3 Lifecycle).
- Tiering: уровни хранения (hot/warm/cold/archival).

```yaml
# Пример: S3 lifecycle policy (упрощённо)
Rules:
  - ID: MoveToGlacier
    Prefix: logs/
    Status: Enabled
    Transitions:
      - Days: 30
        StorageClass: GLACIER
    Expiration:
      Days: 365
```

Пояснение к примеру: автоматическое перемещение старых логов в холодное хранилище экономит деньги, но увеличивает время доступа.

Проверка: проверьте, что объекты старше N дней перешли в нужный класс и что запросы к архивам считаются отдельно.

Типичные ошибки: массовый перенос в cold storage без понимания SLA доступа; отсутствие политики удаления временных файлов и бэкапов.

### Подтема 5. Network и API: egress‑costs и оптимизация запросов

Определения:

- Egress: исходящий интернет‑трафик, часто тарифицируется отдельно.
- Cross‑region traffic: трафик между регионами провайдера.

Короткий вывод: оптимизируйте архитектуру, чтобы уменьшить межрегиональный трафик, используйте CDN для отдачи контента, кэширование для уменьшения запросов к платным API.

Типичные ошибки: разнос сервисов по разным регионам без учета трафика; хранение бэкапов в другом регионе.

### Подтема 6. Процессы FinOps: люди, процессы, данные

Определения:

- FinOps цикл: Inform (видимость) → Optimize (технические меры) → Operate (процессы и распределение ответственности).
- Cost per feature: привязка затрат к продуктовым метрикам.

Короткий вывод: FinOps — не только инструменты, но и культура: договаривайтесь об ответственности, внедряйте регулярные обзоры затрат, KPI для команд и механизмы обратной связи.

Типичные ошибки: сваливать финответственность только на отдельный FinOps‑team; отсутствие автоматических отчётов и регулярных срезов.

### Подтема 7. Инструменты и автоматизация

Определения:

- Native tools: AWS Cost Explorer, Azure Cost Management, GCP Billing.
- Third‑party: Kubecost, CloudHealth, Spot.io, FinOps Foundation tools.

```bash
# Пример: быстрый экспорт затрат (AWS Cost Explorer CLI упрощённо)
aws ce get-cost-and-usage --time-period Start=2025-11-01,End=2025-12-01 --granularity MONTHLY \
  --metrics "BlendedCost" --group-by Type=DIMENSION,Key=SERVICE
```

Пояснение к примеру: экспорт затрат по сервисам даёт обзор, где концентрируются расходы; данные затем можно агрегировать по тэгам.

Проверка: выгрузите отчёт и сравните с данными billing console; проверьте соответствие tag‑mapping.

Типичные ошибки: пытаться вручную анализировать CSV без ETL/BI для затрат; отсутствие единой точной source‑of‑truth для billing data.

## Разбор типичных ошибок и анти‑паттернов

- «Оставим авто‑скейлинг и всё пройдёт»: без лимитов и бюджетов авто‑скейлинг может увеличить расход.
- Игнорирование network egress: неожиданные счета за исходящий трафик.
- Ручная оптимизация без данных: действия наугад могут ухудшить SLO.
- Бороться с затратами в конце квартала: FinOps должен быть итеративным и непрерывным процессом.

## Вопросы для самопроверки

1. Что такое FinOps и какие три организации в нём участвуют?
2. Чем rightsizing отличается от autoscaling?
3. Какие основные статьи облачных затрат?
4. Почему важно использовать тэгирование и какие правила для тэгов рекомендованы?
5. Что такое egress и почему он важен?
6. Когда стоит использовать reserved instances vs spot instances?
7. Какие метрики важны для принятия решений по затратах (p50, p95, cost per feature)?
8. Что такое lifecycle rules для объектов хранения?
9. Как внедрить chargeback/Showback в организации?
10. Какие инструменты помогают автоматизировать FinOps‑задачи?
11. Как связать SLO и бюджет (error budget → финансовые последствия)?
12. Какие ошибки при работе с cold storage могут привести к росту затрат?
13. Что такое Cost Allocation Report?
14. Почему важно иметь source‑of‑truth для billing data?
15. Какие шаги при обнаружении резкого роста затрат?

## Краткий конспект (cheat‑sheet)

- FinOps цикл: Inform → Optimize → Operate.
- Основные статьи затрат: compute, storage, network, managed services.
- Тэгирование: стандарт (project/owner/env/cost_center) + автоматизация в IaC.
- Оптимизации: rightsizing, autoscaling, reserved/savings plans, spot instances, lifecycle и tiering для данных.
- Процессы: бюджеты/алерты, chargeback/showback, регулярные ретроспективы затрат.

## Дополнительно

Глоссарий:

- FinOps: методология управления облачными расходами.
- Rightsizing: переразмеривание ресурсов.
- Egress: исходящий трафик.
- Chargeback/Showback: модели распределения затрат.
- Reserved/Spot: модели покупки compute.

Полезные ссылки:

- FinOps Foundation: [https://www.finops.org](https://www.finops.org)
- AWS Cost Management: [https://aws.amazon.com/aws-cost-management/](https://aws.amazon.com/aws-cost-management/)
- Kubecost: [https://www.kubecost.com](https://www.kubecost.com)

## Быстрая практика

```bash
# 1) Быстрая валидация тэгов в Terraform (статический пример)
terraform plan -out=tfplan
terraform show -json tfplan | jq '.planned_values.root_module.resources[] | {type: .type, name: .name, tags: .values.tags}'

# 2) Получение метрик загрузки для принятия решения о rightsizing
aws cloudwatch get-metric-statistics --namespace AWS/EC2 --metric-name CPUUtilization \
  --start-time 2025-11-01T00:00:00Z --end-time 2025-12-01T00:00:00Z --period 3600 --statistics "Average" --dimensions Name=InstanceId,Value=i-... \
  | jq

# 3) Экспорт затрат по сервисам
aws ce get-cost-and-usage --time-period Start=2025-11-01,End=2025-12-01 --granularity MONTHLY --metrics "BlendedCost" --group-by Type=DIMENSION,Key=SERVICE > costs.json

# 4) Настройка бюджета/алерта в консоли провайдера (рекомендация: порог 80% / 100%)

# 5) Быстрая проверка неиспользуемых ресурсов
aws ec2 describe-volumes --filters Name=status,Values=available
```

Ожидаемый результат: вы получите видимость (отчёт по тэгам), метрики для принятия решения по правкам размеров, экспорт затрат, и настроите бюджет/алерты.

Критерии качества: все обязательные секции присутствуют; определения перед примерами; у каждого примера есть «Пояснение», «Проверка», «Типичные ошибки»; корректные fenced‑блоки и форматирование.
# Лекция 26. Экономика облаков (FinOps)
План:
- Cost-aware дизайн; оптимизация egress/compute/storage
- Резервации/спот, rightsizing
- Наблюдаемость стоимости и бюджеты
Практика: калькуляция TCO сценария.
Чтение: FinOps Foundation (обзор).

## Материал для лекции
- Драйверы стоимости: compute, storage, сеть; egress как ключевой фактор.
- Аллокация/тэгирование, showback/chargeback.
- Rightsizing, резервации/сейвинги, spot/прерываемые инстансы.
- Оптимизация данных: классы хранения, лайфциклы, компрессия.
- Бюджеты, оповещения об аномалиях, прогнозирование.
- Борды наблюдаемости стоимости и ответственность команд (фин. SLO).
