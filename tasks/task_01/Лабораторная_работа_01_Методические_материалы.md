# Примеры приёмов и шаблонов (без привязки к заданию)

Назначение
* Набор независимых примеров, демонстрирующих, как реализовать типовые приёмы: healthcheck, graceful shutdown, multi‑stage Dockerfile, labels/metadata, docker‑compose с зависимостью, .dockerignore, базовые security‑настройки контейнера.
* Это не пошаговая инструкция. Используйте примеры как справочник и адаптируйте под свои условия.

## Быстрый старт

1. Подготовьте минимальный HTTP сервис (любая платформа: Node/Go/Python) с эндпоинтами `/health` и `/ready`.
2. Создайте `Dockerfile` (многостадийный, без root пользователя, с `HEALTHCHECK`).
3. Добавьте `.dockerignore` (исключите node_modules, build артефакты, секреты).
4. Соберите образ: `docker build -t <user>/<app>:v1 .` и запустите: `docker run -p 8080:8080 <user>/<app>:v1`.
5. Проверьте: `curl localhost:8080/health` и `curl localhost:8080/ready`.
6. Оптимизируйте размер: убедитесь, что финальный слой минимальный (alpine/distroless) и нет dev-зависимостей.
7. (Опционально) Добавьте `docker-compose.yml` с зависимостью (например, Redis) и смонтируйте именованный volume.

Далее используйте тематические разделы ниже для углубления (graceful shutdown, security, labels, compose).

## Подготовка (общие рекомендации)

* ПО: Docker Desktop/Engine, Git, редактор кода; по необходимости curl/wget, make.
* Проверка окружения: docker version, docker compose version, доступ к сети (pull образов).
* Структура проекта (пример):
  + src/ — исходники сервиса
  + Dockerfile, .dockerignore
  + docker-compose.yml (если нужен локальный стенд)
  + README.md — краткое описание, параметры запуска, метаданные автора
* Идентификаторы: придерживайтесь «slug» (латиница, [a–z0–9-], lower-case, без пробелов) для имен ресурсов/томов/сетей.
* Порты/эндпоинты: выберите свободный порт и явно описывайте endpoints для liveness/readiness.
* Теги образов: избегайте latest; используйте осмысленные теги (например, по commit SHA/версии).
* Безопасность: запускайте процессы под non‑root, ограничивайте права и поверхность атаки.

## 1) Health/Ready endpoints (разные стеки)

Node/Express

```js
app.get('/health', (req, res) => res.status(200).send('OK'));
app.get('/ready', (req, res) => res.status(200).send('READY'));
```

Python/Flask

```python
@app.get('/health')
def health():
  return ('OK', 200)

@app.get('/ready')
def ready():
  return ('READY', 200)
```

Go net/http

```go
http.HandleFunc("/health", func(w http.ResponseWriter, r *http.Request){ fmt.Fprint(w, "OK") })
http.HandleFunc("/ready",  func(w http.ResponseWriter, r *http.Request){ fmt.Fprint(w, "READY") })
```

## 2) Graceful shutdown (идеи)

Node

```js
const server = app.listen(port);
process.on('SIGTERM', () => server.close(() => process.exit(0)));
```

Go

```go
srv := &http.Server{Addr: ":8080"}
go func(){ _ = srv.ListenAndServe() }()
// signal.Notify(c, syscall.SIGTERM)
<-c
_ = srv.Close()
```

## 3) Multi‑stage Dockerfile (паттерн)

```dockerfile
# syntax=docker/dockerfile:1
FROM node:20-alpine AS deps
WORKDIR /app
COPY package*.json ./
# Примеры приёмов и шаблонов (без привязки к заданию)

Python/Flask

```python
@app.get('/health')
def health():
  return ('OK', 200)

@app.get('/ready')
def ready():
  return ('READY', 200)
```

Go net/http

```go
http.HandleFunc("/health", func(w http.ResponseWriter, r *http.Request){ fmt.Fprint(w, "OK") })
http.HandleFunc("/ready",  func(w http.ResponseWriter, r *http.Request){ fmt.Fprint(w, "READY") })
```

## 2) Graceful shutdown (идеи)

Node

```js
const server = app.listen(port);
process.on('SIGTERM', () => server.close(() => process.exit(0)));
```

Go

```go
srv := &http.Server{Addr: ":8080"}
go func(){ _ = srv.ListenAndServe() }()
// signal.Notify(c, syscall.SIGTERM)
<-c
_ = srv.Close()
```

## 3) Multi‑stage Dockerfile (паттерн)

```dockerfile
# syntax=docker/dockerfile:1
FROM node:20-alpine AS deps
WORKDIR /app
COPY package*.json ./
RUN npm ci --omit=dev

FROM node:20-alpine AS build
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

FROM gcr.io/distroless/nodejs20-debian12
WORKDIR /app
USER 65532:65532
COPY --from=build /app /app
EXPOSE 8080
HEALTHCHECK --interval=30s --timeout=3s CMD ["/usr/bin/curl","-sf","http://127.0.0.1:8080/health"]
ENTRYPOINT ["/usr/bin/node","server.js"]
```

Идеи оптимизации
* Разделяйте слои зависимостей и кода для кэша.
* Используйте alpine/distroless, .dockerignore, удаляйте временные файлы.

## 4) Labels и метаданные OCI

```dockerfile
LABEL org.opencontainers.image.source="https://example.com/repo" \
  org.opencontainers.image.description="demo" \
  org.opencontainers.image.licenses="MIT"
```

Docker Compose labels

```yaml
services:
  app:
    labels:
      com.example.team: "sre"
      com.example.env: "dev"
```

## 5) docker‑compose с зависимостью и volume (паттерн)

```yaml
version: "3.9"
services:
  app:
    image: example/app:1.0.0
    environment:
      PORT: "8080"
    depends_on:
      - redis
    volumes:
      - data:/data
    ports:
      - "8080:8080"
  redis:
    image: redis:7-alpine
    command: ["redis-server","--appendonly","yes"]
    volumes:
      - data:/data
volumes:
  data: {}
```

## 6) .dockerignore (пример)

```
node_modules
.git
**/*.log
**/*.tmp
**/.DS_Store
```

## 7) Базовые настройки безопасности контейнера

* USER non‑root; readonly root filesystem (если возможно).
* Ограничить capabilities; по возможности seccomp/AppArmor профиль.
* Явно объявлять открытые порты; не использовать latest‑тег.

## 8) Префиксы ключей и именование

* Пример префикса: app:context:entity:id
* Имена ресурсов: использовать только [a-z0-9-], длину и DNS‑ограничения учитывать (например, ≤63).

## Ссылки на теорию (web)

* Health/Liveness/Readiness
  + Kubernetes Probes (liveness/readiness/startup): https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/
  + Dockerfile HEALTHCHECK: https://docs.docker.com/reference/dockerfile/#healthcheck
  + Express (Routing): https://expressjs.com/en/guide/routing.html
  + Flask (Quickstart/Routes): https://flask.palletsprojects.com/en/stable/quickstart/
  + Go net/http: https://pkg.go.dev/net/http

* Graceful shutdown
  + Node.js — сигналы процесса: https://nodejs.org/api/process.html#signal-events
  + Node.js — server.close: https://nodejs.org/api/http.html#serverclosecallback
  + Go http. Server. Shutdown: https://pkg.go.dev/net/http#Server.Shutdown

* Dockerfile и образы
  + Multi‑stage builds: https://docs.docker.com/build/building/multi-stage/
  + Dockerfile reference: https://docs.docker.com/reference/dockerfile/
  + Distroless образы: https://github.com/GoogleContainerTools/distroless

* Метаданные и labels
  + OCI Image Spec — annotations: https://github.com/opencontainers/image-spec/blob/main/annotations.md
  + Docker labels (image): https://docs.docker.com/reference/label/
  + Compose service labels: https://docs.docker.com/compose/compose-file/05-services/#labels

* Docker Compose
  + Compose спецификация: https://compose-spec.io
  + depends_on: https://docs.docker.com/compose/compose-file/05-services/#dependson
  + volumes: https://docs.docker.com/compose/compose-file/07-volumes/

* .dockerignore
  + Игнорирование контекста сборки: https://docs.docker.com/build/concepts/context/#dockerignore-files

* Безопасность контейнеров
  + Обзор безопасности Docker: https://docs.docker.com/security/
  + Rootless mode: https://docs.docker.com/engine/security/rootless/
  + Linux capabilities: https://man7.org/linux/man-pages/man7/capabilities.7.html
  + OWASP Docker Security Cheat Sheet: https://cheatsheetseries.owasp.org/cheatsheets/Docker_Security_Cheat_Sheet.html

* Именование и slug
  + Kubernetes DNS label names (ограничения): https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#dns-label-names
  + Docker image tags (правила именования): https://docs.docker.com/reference/cli/docker/image/tag/
  + URL Slug (общее понятие): https://en.wikipedia.org/wiki/Clean_URL

```
